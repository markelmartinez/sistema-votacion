<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Concurso de Pintxos — Jurado Popular</title>
  <meta name="theme-color" content="#111" />

  <!-- Fuente festiva para el slogan -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">

  <style>
    :root{
      --ink:#0f172a;
      --muted:#667085;
      --border:#e6e8ec;
      --brand:#ff6b00;
      --brand-2:#0ea5e9;
      --brand-3:#10b981;
      --chip:#f1f5f9;
      --hero-base:#a85f2b;
    }
    *{box-sizing:border-box}
    html,body{margin:0;overflow-x:hidden}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;background:#fafafa;color:var(--ink)}
    a{color:inherit}

    header{
      position: sticky; top: 0; z-index: 8; border-bottom: 1px solid var(--border);
      background:
        linear-gradient(90deg,
          rgba(0,0,0,.78) 0%,
          rgba(0,0,0,.55) 38%,
          rgba(0,0,0,.28) 70%,
          rgba(0,0,0,.12) 100%
        ),
        var(--hero, var(--hero-base));
      background-color: var(--hero-base);
      background-position: center;
      background-repeat: no-repeat;
      background-size: calc(100% * var(--hero-zoom, 1));
      color:#fff;
      width: 100vw; max-width: 100vw;
      margin-left: calc(50% - 50vw);
      margin-right: calc(50% - 50vw);
    }
    .hero{
      padding: 18px 16px 12px;
      min-height: 240px;
      display:flex; flex-direction:column; justify-content:flex-end;
      backdrop-filter:saturate(120%);
    }
    .topbar{display:flex;align-items:center;gap:12px;justify-content:space-between}
    h1{
      margin:0;font-size:20px;line-height:1.2;
      display:inline-block;padding:6px 10px;border-radius:10px;
      background: rgba(0,0,0,.35); text-shadow: 0 2px 10px rgba(0,0,0,.45);
    }

    .slogan-wrap{width:100%; text-align:center; margin:10px 0 8px;}
    .slogan{
      font-family:"Pacifico", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, cursive;
      font-size: clamp(18px, 3vw, 28px);
      line-height: 1.15;
      color:#fff;
      text-shadow: 0 3px 14px rgba(0,0,0,.6), 0 1px 3px rgba(0,0,0,.35);
      letter-spacing:.2px;
      display:inline-block;
      padding:4px 10px;
      border-radius:12px;
      background: linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.05));
    }
    .slogan-logo-wrap{ text-align:center; margin-top:6px; }
    .slogan-logo{
      height:64px; width:auto;
      filter: drop-shadow(0 2px 8px rgba(0,0,0,.35));
    }
    @media (min-width: 900px){ .slogan-logo{ height:72px; } }

    .lang{display:flex;gap:8px}
    .pill{padding:7px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.6);background:rgba(255,255,255,.08);color:#fff;cursor:pointer}
    .pill.active{background:#fff;color:#111;border-color:#fff}
    .tabs{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
    .tab{padding:9px 14px;border:1px solid rgba(255,255,255,.7);border-radius:999px;background:rgba(255,255,255,.1);cursor:pointer;color:#fff;backdrop-filter:blur(4px)}
    .tab.active{background:#fff;color:#111;border-color:#fff;box-shadow:0 2px 10px rgba(0,0,0,.08)}

    main{padding:16px;max-width:1200px;margin:0 auto}
    .search{width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:12px;margin-bottom:16px;background:#fff}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px}
    .card{border:1px solid var(--border);border-radius:18px;overflow:hidden;background:#fff;box-shadow:0 2px 10px rgba(2,6,23,.04)}
    .photo{width:100%;height:170px;object-fit:cover;background:#f1f5f9;display:block}
    .content{padding:12px}
    .title{font-weight:800;margin-bottom:2px}
    .address{color:var(--muted);font-size:14px}
    .actions{display:flex;gap:10px;margin-top:10px}
    .btn{flex:1;text-align:center;text-decoration:none;border-radius:14px;padding:11px 12px;transition:.18s all ease}
    .btn.primary{background:var(--brand);color:#fff;border:1px solid var(--brand)}
    .btn.primary:hover{filter:brightness(.95);transform:translateY(-1px)}
    .btn.ghost{border:1px solid var(--ink);background:#fff;color:var(--ink)}
    .btn.ghost:hover{background:#111;color:#fff}
    .empty{color:#777;text-align:center;padding:40px}

    .rank-wrap{max-width:960px;margin:0 auto}
    table{width:100%;border-collapse:collapse;border:1px solid var(--border);border-radius:14px;overflow:hidden;background:#fff}
    thead th{background:#f8fafc;text-align:left;font-weight:800}
    th, td{padding:10px;border-bottom:1px solid #eef2f7}
    tr:nth-child(even) td{background:#fcfdff}
    .chip{display:inline-block;padding:4px 8px;border-radius:999px;background:var(--chip);font-size:12px;color:#0f172a}
    .pos{width:48px;text-align:center;font-variant-numeric:tabular-nums}
    .num{text-align:right;font-variant-numeric:tabular-nums}
    .updated{color:#888;font-size:12px;margin:8px 0 6px}
    .criteria-note{color:#6b7280;font-size:14px;margin:0 0 16px}
    footer{color:#888;font-size:12px;text-align:center;padding:28px}

    #btn-es.active{background:var(--brand-2)!important;border-color:var(--brand-2)!important;color:#fff}
    #btn-eu.active{background:var(--brand-3)!important;border-color:var(--brand-3)!important;color:#fff}
  </style>
</head>
<body>
  <header>
    <div class="hero">
      <div class="topbar">
        <h1 id="title">Concurso de Pintxos — Jurado Popular</h1>
        <div class="lang">
          <button id="btn-es" class="pill active">CAS</button>
          <button id="btn-eu" class="pill">EUS</button>
        </div>
      </div>

      <div class="slogan-wrap">
        <div class="slogan">Gora Uribarri eta Matikoko jaiak!</div>
        <div class="slogan-logo-wrap">
          <img class="slogan-logo"
               src="https://markelmartinez.github.io/sistema-votacion/urtiko.png"
               alt="Logo"
               loading="eager"
               decoding="async" />
        </div>
      </div>

      <div class="tabs">
        <button id="tab-bares" class="tab active">Bares</button>
        <button id="tab-ranking" class="tab">Clasificacion en vivo</button>
      </div>
    </div>
  </header>

  <main>
    <!-- Vista Bares -->
    <section id="view-bares">
      <input id="search" class="search" placeholder="Busca por nombre o dirección..." />
      <div id="grid" class="grid"></div>
      <div id="empty" class="empty" style="display:none">No hay resultados.</div>
    </section>

    <!-- Vista Ranking -->
    <section id="view-ranking" style="display:none">
      <div class="rank-wrap">
        <div class="updated" id="rank-updated"></div>
        <p class="criteria-note" id="criteria-note"></p>
        <table>
          <thead>
            <tr>
              <th class="pos">#</th>
              <th id="th-bar">Bar</th>
              <th class="num" id="th-puntos">Puntos</th>
              <th class="num" id="th-votos">Votos</th>
              <th class="num" id="th-media">Media</th>
            </tr>
          </thead>
          <tbody id="rank-tbody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer id="footer">Votación 1–10 · Un voto por persona y bar · © Auzotik auzoarentzat</footer>

  <script>
    /* ========= Config ========= */
    const HERO_IMG = "https://markelmartinez.github.io/sistema-votacion/pintxos.jpg";
    const dynStyle = document.createElement('style');
    dynStyle.textContent = `header{ --hero: url('${HERO_IMG}'); --hero-zoom: 0.85; }`;
    document.head.appendChild(dynStyle);

    // A,C,F,H -> nombre, enlace, dirección, foto
    const GVIZ_URL_BARES =
      "https://docs.google.com/spreadsheets/d/1o9-3b-GwN8Z8QEmTIBTAahP8sXPF8oMrn-AB7MQMTew/gviz/tq?tqx=out:json&gid=2039727451&tq=select%20A,C,F,H&headers=1";
    const GVIZ_URL_RANKING =
      "https://docs.google.com/spreadsheets/d/1o9-3b-GwN8Z8QEmTIBTAahP8sXPF8oMrn-AB7MQMTew/gviz/tq?tqx=out:json&sheet=Ranking";

    /* ========= i18n ========= */
    const I18N = {
      es: {
        title: "Concurso de Pintxos — Jurado Popular",
        tab_bares: "Bares",
        tab_rank: "Clasificacion en vivo",
        search: "Busca por nombre o dirección...",
        empty: "No hay resultados.",
        voteBtn: "Votar 1–10",
        mapsBtn: "Cómo llegar",
        updated: "Actualizado:",
        th_bar: "Bar",
        th_pts: "Puntos",
        th_votes: "Votos",
        th_avg: "Media",
        criteria: "Ganador: el bar con más puntos. En caso de empate, se tendrá en cuenta la media y después el número de votos.",
        footer: "Votación 1–10 · Un voto por persona y bar · © Auzotik auzoarentzat",
      },
      eu: {
        title: "Pintxo Lehiaketa — Epaimahai Herrikoia",
        tab_bares: "Tabernak",
        tab_rank: "Sailkapena zuzenean",
        search: "Bilatu izenaren edo helbidearen arabera...",
        empty: "Emaitzik ez.",
        voteBtn: "Bozkatu 1-10",
        mapsBtn: "Nola iritsi",
        updated: "Eguneratua:",
        th_bar: "Taberna",
        th_pts: "Puntuak",
        th_votes: "Bozkak",
        th_avg: "Batezbestekoa",
        criteria: "Irabazlea: puntu gehien dituen taberna. Berdinketa gertatuz gero, batezbestekoa eta ondoren bozk kopurua hartuko dira kontuan.",
        footer: "Bozketa 1–10 · Pertsona eta taberna bakoitzeko bozka bakarra · © Auzotik auzoarentzat",
      }
    };

    function getLang(){
      const urlParam = new URLSearchParams(location.search).get('lang');
      if(urlParam === 'eu' || urlParam === 'es'){ localStorage.setItem('lang',urlParam); return urlParam; }
      return localStorage.getItem('lang') || 'es';
    }
    let LANG = getLang();

    function applyI18n(){
      const t = I18N[LANG];
      document.documentElement.lang = (LANG==='eu' ? 'eu' : 'es');
      document.getElementById('title').textContent = t.title;
      document.getElementById('tab-bares').textContent = t.tab_bares;
      document.getElementById('tab-ranking').textContent = t.tab_rank;
      document.getElementById('search').placeholder = t.search;
      document.getElementById('empty').textContent = t.empty;
      document.getElementById('th-bar').textContent = t.th_bar;
      document.getElementById('th-puntos').textContent = t.th_pts;
      document.getElementById('th-votos').textContent = t.th_votes;
      document.getElementById('th-media').textContent = t.th_avg;
      document.getElementById('criteria-note').textContent = t.criteria;
      document.getElementById('footer').textContent = t.footer;

      document.querySelectorAll('[data-i18n="voteBtn"]').forEach(a => a.textContent = t.voteBtn);
      document.querySelectorAll('[data-i18n="mapsBtn"]').forEach(a => a.textContent = t.mapsBtn);

      document.getElementById('btn-es').classList.toggle('active', LANG==='es');
      document.getElementById('btn-eu').classList.toggle('active', LANG==='eu');
    }

    async function fetchGViz(url){
      const nocache = (url.includes("?") ? "&" : "?") + "_=" + Date.now();
      const res = await fetch(url + nocache);
      const text = await res.text();
      const start = text.indexOf('{');
      const end   = text.lastIndexOf('}');
      return JSON.parse(text.slice(start, end + 1));
    }

    async function fetchBares(){
      const json = await fetchGViz(GVIZ_URL_BARES);
      const rows = json.table?.rows || [];
      return rows
        .map(r => ({
          nombre:    r.c?.[0]?.v || "",
          link:      r.c?.[1]?.v || "",
          direccion: r.c?.[2]?.v || "",
          foto:      r.c?.[3]?.v || ""
        }))
        .filter(b => b.nombre && b.nombre !== "Bar" && b.link);
    }

    async function fetchRanking(){
      const json = await fetchGViz(GVIZ_URL_RANKING);
      const rows = json.table?.rows || [];
      const data = rows.map(r => ({
        bar:    r.c?.[0]?.v || "",
        votos:  Number(r.c?.[1]?.v ?? 0),
        media:  Number(r.c?.[2]?.v ?? 0),
        puntos: Number(r.c?.[3]?.v ?? 0)
      }));
      // Orden: puntos > media > votos (coincide con la nota)
      data.sort((a,b) =>
        (b.puntos - a.puntos) ||
        (b.media  - a.media)  ||
        (b.votos  - a.votos)
      );
      return data;
    }

    const grid  = document.getElementById('grid');
    const empty = document.getElementById('empty');
    const search= document.getElementById('search');

    function renderBares(list){
      const t = I18N[LANG];
      grid.innerHTML = '';
      list.forEach(b => {
        const card = document.createElement('div'); card.className='card';

        const img = document.createElement('img');
        img.className='photo'; img.alt=b.nombre; img.loading='lazy';
        img.src = (b.foto||'').trim() || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';

        const content=document.createElement('div'); content.className='content';
        const title=document.createElement('div'); title.className='title'; title.textContent=b.nombre;
        const addr=document.createElement('div'); addr.className='address';
        if (b.direccion) addr.textContent = b.direccion.trim();

        const actions=document.createElement('div'); actions.className='actions';
        const votar=document.createElement('a'); votar.className='btn primary'; votar.href=b.link; votar.target='_blank'; votar.rel='noopener noreferrer'; votar.dataset.i18n="voteBtn"; votar.textContent=t.voteBtn;

        const maps=document.createElement('a');
        maps.className='btn ghost';
        maps.href='https://www.google.com/maps/search/'+encodeURIComponent(b.nombre+' '+(b.direccion||''));
        maps.target='_blank'; maps.rel='noopener noreferrer';
        maps.dataset.i18n="mapsBtn"; maps.textContent=t.mapsBtn;

        actions.appendChild(votar); actions.appendChild(maps);
        content.appendChild(title); if (b.direccion) content.appendChild(addr); content.appendChild(actions);
        card.appendChild(img); card.appendChild(content);
        grid.appendChild(card);
      });
      empty.style.display = list.length ? 'none' : 'block';
    }

    const rankBody    = document.getElementById('rank-tbody');
    const rankUpdated = document.getElementById('rank-updated');

    function renderRanking(rows){
      rankBody.innerHTML = '';
      rows.forEach((r,i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="pos"><span class="chip">#${i+1}</span></td>
          <td>${r.bar}</td>
          <td class="num">${r.puntos}</td>
          <td class="num">${r.votos}</td>
          <td class="num">${r.media.toFixed(2)}</td>
        `;
        rankBody.appendChild(tr);
      });
      const t = I18N[LANG];
      rankUpdated.textContent = `${t.updated} ${new Date().toLocaleString()}`;
    }

    const tabBares=document.getElementById('tab-bares'), tabRanking=document.getElementById('tab-ranking');
    const viewBares=document.getElementById('view-bares'), viewRanking=document.getElementById('view-ranking');
    tabBares.onclick=()=>{tabBares.classList.add('active');tabRanking.classList.remove('active');viewBares.style.display='';viewRanking.style.display='none';};
    tabRanking.onclick=()=>{tabRanking.classList.add('active');tabBares.classList.remove('active');viewRanking.style.display='';viewBares.style.display='none';};

    let LISTA=[];
    function filtrar(){
      const q=search.value.trim().toLowerCase();
      renderBares(LISTA.filter(b =>
        b.nombre.toLowerCase().includes(q) ||
        (b.direccion||'').toLowerCase().includes(q)
      ));
    }
    search.addEventListener('input', filtrar);

    document.getElementById('btn-es').onclick = ()=>{ LANG='es'; localStorage.setItem('lang','es'); applyI18n(); filtrar(); renderRankingCache(); history.replaceState(null,"",location.pathname+"?lang=es"); };
    document.getElementById('btn-eu').onclick = ()=>{ LANG='eu'; localStorage.setItem('lang','eu'); applyI18n(); filtrar(); renderRankingCache(); history.replaceState(null,"",location.pathname+"?lang=eu"); };

    let RANK_CACHE=[];
    function renderRankingCache(){ if(RANK_CACHE.length) renderRanking(RANK_CACHE); }

    (async () => {
      try {
        applyI18n();
        LISTA = await fetchBares(); renderBares(LISTA);
        RANK_CACHE = await fetchRanking(); renderRanking(RANK_CACHE);
      } catch(e){
        console.error(e);
        empty.style.display='block';
        empty.textContent = I18N[LANG].empty;
      }
    })();
  </script>
</body>
</html>
